// Generated by Copilot: Adding branch protection workflow for TensorZero integration
name: Branch Protection

on:
  pull_request:
    branches: [main, master]
  push:
    branches: [main, master]

jobs:
  integration-checks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: "3.8"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements/common.txt
          pip install -r requirements/developer.txt

      - name: Run unit tests
        run: python -m pytest cpp/test/test_tensorzero_handler.cc

      - name: Run integration tests
        run: python torchserve_sanity.py

      - name: Verify documentation
        run: |
          python ts_scripts/validate_documentation.py

      - name: Security scan
        run: |
          pip install bandit
          bandit -r . -ll

  status-checks:
    needs: integration-checks
    runs-on: ubuntu-latest
    steps:
      - name: Check build status
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "All checks passed"
            exit 0
          else
            echo "Checks failed"
            exit 1
          fi

  require-reviews:
    runs-on: ubuntu-latest
    steps:
      - name: Check review status
        run: |
          REVIEWS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                   "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/reviews")
          APPROVALS=$(echo $REVIEWS | grep -o '"state": "APPROVED"' | wc -l)
          if [ "$APPROVALS" -lt 2 ]; then
            echo "Need at least 2 approvals"
            exit 1
          fi
